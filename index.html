<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ferric Carboxymaltose (FCM) Dose Calculator</title>
  <meta name="description" content="Calculate iron deficit and suggest an FCM dosing plan (informational use only)." />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --card:#0b1222;
    }
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1222 0%, #0f172a 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:900px;margin:32px auto;padding:16px;}
    .card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,0.35)}
    h1{font-size:28px;margin:0 0 8px}
    p.sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:#0f1a33;color:var(--text)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    button{padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#052e14}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.18);color:var(--text)}
    .danger{background:var(--danger);color:#fff}
    .result{margin-top:20px;padding:16px;border-radius:12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25)}
    .muted{color:var(--muted)}
    small{color:var(--muted)}
    a{color:#93c5fd}
    footer{margin-top:18px;font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1a33;border:1px solid rgba(255,255,255,0.1)}
    .list{margin:8px 0 0 18px}
    .list li{margin:6px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ferric Carboxymaltose (FCM) Dose Calculator</h1>
      <p class="sub">Computes iron deficit with the Ganzoni method and proposes an FCM split plan. <b>For education only — not medical advice.</b></p>

      <div class="grid">
        <div>
          <label>Weight (kg)</label>
          <input id="weight" type="number" min="1" step="0.1" value="70">
        </div>
        <div>
          <label>Current Hb (g/dL)</label>
          <input id="hb" type="number" min="1" max="25" step="0.1" value="9.5">
        </div>
        <div>
          <label>Target Hb (g/dL)</label>
          <input id="target" type="number" min="7" max="16" step="0.1" value="13">
        </div>
        <div>
          <label>Depot iron (mg) <small class="muted">(store)</small></label>
          <input id="depot" type="number" min="0" step="50" value="500">
        </div>
        <div>
          <label>Ferritin (µg/L) <small class="muted">(optional)</small></label>
          <input id="ferritin" type="number" min="0" step="1" placeholder="e.g. 15">
        </div>
        <div>
          <label>Blood volume factor</label>
          <select id="factor">
            <option value="2.4">2.4 (default adults)</option>
            <option value="2.0">2.0 (smaller body size)</option>
            <option value="3.0">3.0 (larger body size)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button class="primary" onclick="calc()">Calculate</button>
        <button class="ghost" onclick="prefill(60,8.5,13,500,10)">Example</button>
        <button class="danger" onclick="resetForm()">Reset</button>
      </div>

      <div id="out" class="result" style="display:none"></div>
      <footer>
        <div class="pill">Rules applied</div>
        <ul class="list">
          <li>Iron deficit (mg) = <b>weight × (targetHb − currentHb) × factor + depot</b>.</li>
          <li>If ferritin ≥ 100 µg/L, depot is reduced to 200 mg; if ferritin ≥ 300 µg/L, depot = 0 mg.</li>
          <li>FCM split plan caps each dose at <b>≤ 1000 mg</b> and <b>≤ 15 mg/kg</b> (whichever is smaller) per week.</li>
        </ul>
      </footer>
    </div>
  </div>

  <script>
    function prefill(w,h,t,d,f){weight.value=w;hb.value=h;target.value=t;depot.value=d;ferritin.value=f;calc();}
    function resetForm(){
      weight.value=70; hb.value=9.5; target.value=13; depot.value=500; ferritin.value="";
      factor.value="2.4"; out.style.display="none"; out.innerHTML="";
    }
    function clampDosePerSession(totalMg, kg){
      const byWeight = Math.floor(15 * kg);     // 15 mg/kg
      const cap = Math.min(1000, byWeight);     // ≤1000 mg and ≤15 mg/kg
      return Math.min(cap, totalMg);
    }
    function suggestPlan(totalMg, kg){
      const sessions = [];
      let remaining = Math.round(totalMg);
      while(remaining > 0){
        const thisDose = clampDosePerSession(remaining, kg);
        sessions.push(thisDose);
        remaining -= thisDose;
      }
      return sessions;
    }
    function calc(){
      const kg = parseFloat(weight.value||0);
      const hbNow = parseFloat(hb.value||0);
      const hbTarget = parseFloat(target.value||0);
      const dep = parseFloat(depot.value||0);
      const fac = parseFloat(factor.value||2.4);
      const ferr = parseFloat(ferritin.value||NaN);

      if(!(kg>0) || !(hbTarget>0) || !(hbNow>=0) || !(fac>0)){ alert("Please check inputs."); return; }

      // Adjust depot by ferritin (simple heuristic)
      let adjDepot = dep;
      if(!Number.isNaN(ferr)){
        if(ferr >= 300) adjDepot = 0;
        else if(ferr >= 100) adjDepot = Math.min(dep, 200);
      }

      const deficit = kg * (hbTarget - hbNow) * fac + adjDepot;
      const needMg = Math.max(0, Math.round(deficit));

      const plan = suggestPlan(needMg, kg);
      const totalSessions = plan.length;

      out.style.display="block";
      out.innerHTML = `
        <h3 style="margin:0 0 8px">Estimated iron need: ${needMg.toLocaleString()} mg</h3>
        <div class="muted" style="margin-bottom:10px">Depot used: ${adjDepot} mg ${!Number.isNaN(ferr) ? `(ferritin=${ferr} µg/L)` : ""}</div>
        ${needMg===0 ? "<div>No deficit estimated.</div>" : `
          <div><b>Suggested FCM plan</b> (weekly):</div>
          <ul class="list">${plan.map((d,i)=>`<li>Session ${i+1}: <b>${d} mg</b></li>`).join("")}</ul>
          <div class="muted" style="margin-top:8px">Caps applied: ≤1000 mg per session and ≤15 mg/kg.</div>
          <div class="muted">Total sessions: ${totalSessions}</div>
        `}
        <div class="muted" style="margin-top:10px"><small>This tool is for education only and does not replace clinical judgment or product labeling.</small></div>
      `;
    }
    // Optional: register SW if present (won't block rendering)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
