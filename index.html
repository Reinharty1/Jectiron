<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jectiron – Ganzoni Dose Calculator</title>
  <meta name="description" content="Jectiron iron dose calculator using Ganzoni formula with ferritin-adjusted depot iron." />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Jectiron Dose" />
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22c55e; /* green-500 */
      --accent2:#60a5fa; /* blue-400 */
      --danger:#ef4444; /* red-500 */
    }
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:linear-gradient(180deg, #0b1220, #0f172a); color:var(--text)}
    .wrap{max-width:980px; margin:0 auto; padding:24px}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px}
    .title{font-size:clamp(22px, 3vw, 32px); font-weight:800; letter-spacing:0.2px}
    .subtitle{color:var(--muted); font-size:14px}
    .card{background:rgba(17,24,39,.75); border:1px solid rgba(148,163,184,.15); backdrop-filter: blur(6px); border-radius:20px; padding:18px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:820px){ .grid{grid-template-columns:1.2fr .8fr} }
    label{display:block; font-weight:700; font-size:14px; margin-bottom:6px}
    input[type="number"], select{
      width:100%; background:#0b1220; color:var(--text); border:1px solid rgba(148,163,184,.25);
      border-radius:12px; padding:12px; font-size:16px; outline:none; transition:border .2s, box-shadow .2s
    }
    input[type="number"]:focus, select:focus{border-color:var(--accent2); box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .hint{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .switch{display:flex; align-items:center; gap:10px}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid rgba(148,163,184,.25); background:#0b1220; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn.primary{background:linear-gradient(135deg, #22c55e, #16a34a); border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(135deg, #ef4444, #b91c1c); border-color:transparent}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .k{background:#0b1220; border:1px solid rgba(148,163,184,.2); border-radius:16px; padding:16px}
    .k .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
    .k .value{font-size:clamp(18px, 3.2vw, 28px); font-weight:900; margin-top:6px}
    details{background:#0b1220; border:1px dashed rgba(148,163,184,.35); border-radius:16px; padding:14px}
    summary{cursor:pointer; font-weight:800}
    .footer{margin-top:18px; font-size:12px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; background:#0b1220; border:1px solid rgba(148,163,184,.25); padding:8px 10px; border-radius:999px; font-weight:700}
    .out{white-space:pre-wrap; background:#0b1220; border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:12px}
  </style>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Jectiron – Ganzoni Dose Calculator</div>
        <div class="subtitle">Ferritin‑adjusted depot iron • adult use • educational aid</div>
      </div>
      <div class="badge" title="Default depot iron is 500 mg when ferritin is low.">Depot default: 500 mg</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <label for="weight">Body weight (kg)</label>
            <input id="weight" type="number" step="0.1" min="1" placeholder="e.g., 70" />
            <div class="hint">Use actual or dosing weight per your protocol.</div>
          </div>
          <div>
            <label for="targetHb">Target Hb (g/dL)</label>
            <input id="targetHb" type="number" step="0.1" min="5" max="18" value="15" />
            <div class="hint">Common targets 13–15 g/dL (individualize).</div>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="actualHb">Actual Hb (g/dL)</label>
            <input id="actualHb" type="number" step="0.1" min="0" max="18" placeholder="e.g., 9.5" />
          </div>
          <div>
            <label for="ferritin">Ferritin (ng/mL)</label>
            <input id="ferritin" type="number" step="1" min="0" placeholder="e.g., 25" />
          </div>
        </div>

        <div class="row">
          <div class="switch">
            <input id="inflamm" type="checkbox" />
            <label for="inflamm">CKD / active inflammation suspected</label>
          </div>
          <div class="switch">
            <input id="cap1000" type="checkbox" checked />
            <label for="cap1000">Cap single session at 1000 mg</label>
          </div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="btn primary" id="calcBtn">Calculate</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
          <button class="btn ghost" id="copyBtn">Copy results</button>
        </div>
      </section>

      <section class="card">
        <div class="kpi">
          <div class="k">
            <div class="label">Iron deficit</div>
            <div class="value" id="ironDef">—</div>
            <div class="hint">kg × (Target−Actual) × 2.4</div>
          </div>
          <div class="k">
            <div class="label">Depot iron</div>
            <div class="value" id="depot">—</div>
            <div class="hint" id="depotHint">Ferritin‑adjusted</div>
          </div>
          <div class="k">
            <div class="label">Total dose</div>
            <div class="value" id="total">—</div>
            <div class="hint">Rounded to 100 mg vials</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>IV Iron plan</label>
          <div class="out" id="plan">Results will appear here…</div>
        </div>
      </section>
    </div>

    <details style="margin-top:14px">
      <summary>How is depot iron chosen?</summary>
      <div class="muted" style="margin-top:8px">
        <ul>
          <li><b>Ferritin &lt; 30</b> ng/mL (no inflammation) <i>or</i> <b>&lt; 100</b> ng/mL (if CKD/inflammation): add <b>+500 mg</b>.</li>
          <li><b>Ferritin 100–300</b>: add <b>+200–300 mg</b> (use 250 mg default).</li>
          <li><b>Ferritin 300–500</b>: consider <b>+100–200 mg</b> (use 150 mg default).</li>
          <li><b>Ferritin &gt; 500</b>: add <b>0 mg</b>.</li>
        </ul>
        <p class="hint">These are common pragmatic cutoffs; individualize for pregnancy, pediatrics, or high ferritin states. This tool does not replace clinical judgment.</p>
      </div>
    </details>

    <details style="margin-top:10px">
      <summary>Formula (Ganzoni)</summary>
      <div class="muted" style="margin-top:8px">
        Total Iron Dose (mg) = <b>Weight</b> (kg) × (<b>Target Hb</b> − <b>Actual Hb</b>) (g/dL) × <b>2.4</b> + <b>Depot Iron</b>
      </div>
    </details>

    <p class="footer">⚠️ Educational aid only. Verify doses against local guidelines and product labels (e.g., Ferosac / ferric carboxymaltose / other IV iron). Not for pediatric dosing.
    </p>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const weight = $("weight"), targetHb=$("targetHb"), actualHb=$("actualHb"), ferritin=$("ferritin"), inflamm=$("inflamm"), cap1000=$("cap1000");
  const ironDef=$("ironDef"), depot=$("depot"), total=$("total"), plan=$("plan"), depotHint=$("depotHint");
  const calcBtn=$("calcBtn"), resetBtn=$("resetBtn"), copyBtn=$("copyBtn");

  function roundToVial(mg){
    // round to nearest 100 mg (common vial granularity)
    return Math.round(mg/100)*100;
  }

  function chooseDepot(ferr, infl){
    let note="Ferritin‑adjusted";
    if(isNaN(ferr)) return {mg:500, note:"Ferritin unknown → default 500 mg"};
    if(!infl){
      if(ferr < 30) return {mg:500, note:"Ferritin < 30 → +500 mg"};
    } else {
      if(ferr < 100) return {mg:500, note:"Inflamm/CKD & Ferritin < 100 → +500 mg"};
    }
    if(ferr < 100) return {mg:500, note:"Ferritin < 100 → +500 mg"};
    if(ferr < 300) return {mg:250, note:"Ferritin 100–300 → +250 mg"};
    if(ferr < 500) return {mg:150, note:"Ferritin 300–500 → +150 mg"};
    return {mg:0, note:"Ferritin > 500 → +0 mg"};
  }

  function planDoses(totalMg){
    // Suggest sessions (e.g., 1000 mg max per session if selected)
    const sessions=[];
    let remaining = totalMg;
    const cap = cap1000.checked ? 1000 : Infinity;
    while(remaining>0){
      const dose = Math.min(remaining, cap);
      sessions.push(dose);
      remaining -= dose;
    }
    return sessions;
  }

  function formatPlan(sessions){
    return sessions.map((d,i)=>`Session ${i+1}: ${d.toLocaleString()} mg`).join("\n");
  }

  function calc(){
    const w = parseFloat(weight.value);
    const t = parseFloat(targetHb.value);
    const a = parseFloat(actualHb.value);
    const f = parseFloat(ferritin.value);

    if(!w || isNaN(t) || isNaN(a)){
      plan.textContent = "Enter weight, target Hb, and actual Hb.";
      ironDef.textContent = depot.textContent = total.textContent = "—";
      depotHint.textContent = "Ferritin‑adjusted";
      return;
    }
    if(t <= a){
      plan.textContent = "Target Hb must be greater than actual Hb for deficit calculation.";
      ironDef.textContent = depot.textContent = total.textContent = "—";
      depotHint.textContent = "Ferritin‑adjusted";
      return;
    }

    const deficit = w * (t - a) * 2.4; // Ganzoni core
    const depotObj = chooseDepot(f, inflamm.checked);
    const rawTotal = deficit + depotObj.mg;

    const roundedTotal = roundToVial(rawTotal);

    ironDef.textContent = `${Math.round(deficit).toLocaleString()} mg`;
    depot.textContent = `${depotObj.mg} mg`;
    depotHint.textContent = depotObj.note;
    total.textContent = `${roundedTotal.toLocaleString()} mg`;

    const sessions = planDoses(roundedTotal);
    const txt = `Calculated with Ganzoni:\n  Deficit = ${Math.round(deficit)} mg\n  Depot = ${depotObj.mg} mg (${depotObj.note})\n  Total (rounded to 100 mg) = ${roundedTotal} mg\n\nSuggested IV iron plan${cap1000.checked?" (≤1000 mg/session)":""}:\n${formatPlan(sessions)}\n\nNotes:\n• Round per your vial size and product label.\n• Recheck Hb/TSAT/ferritin after repletion as per protocol.`;
    plan.textContent = txt;
  }

  function reset(){
    weight.value = ""; actualHb.value=""; ferritin.value=""; targetHb.value=15; inflamm.checked=false; cap1000.checked=true;
    ironDef.textContent = depot.textContent = total.textContent = "—"; plan.textContent = "Results will appear here…"; depotHint.textContent = "Ferritin‑adjusted";
  }

  function copy(){
    const text = `Jectiron – GANZONI RESULT\n` + plan.textContent;
    navigator.clipboard.writeText(text).then(()=>{
      copyBtn.textContent = "Copied ✓";
      setTimeout(()=>copyBtn.textContent="Copy results",1200);
    }).catch(()=>{
      copyBtn.textContent = "Copy failed";
      setTimeout(()=>copyBtn.textContent="Copy results",1200);
    });
  }

  calcBtn.addEventListener("click", calc);
  resetBtn.addEventListener("click", reset);
  copyBtn.addEventListener("click", copy);
})();
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
    });
  }
</script>
</body>
</html>
